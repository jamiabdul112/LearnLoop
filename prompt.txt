# Skill Exchange MERN App Architecture

Perfect, letâ€™s architect this Skill Exchange MERN app step by step. Since you already have the `package.json` and folder alignment, weâ€™ll map out exactly what schemas, controllers, routes, middleware, and utils youâ€™ll need.

---

### ðŸ“Œ Schemas (Models)

**1. User Model**
- `name`: String
- `email`: String (unique)
- `password`: String (hashed)
- `profileImg`: String (Cloudinary URL)
- `address`: String
- `about`: String
- `skillsOffered`: Array (Skill refs or Strings)
- `skillsWanted`: Array (Skill refs or Strings)
- `reviews`: Array (Review refs)
- `chats`: Array (Chat refs)

**2. Skill Model**
- `title`: String (e.g., "Guitar Lessons")
- `category`: Enum (music, tech, dance, etc.)
- `description`: String
- `owner`: User ref
- `createdAt`: Date

**3. TradeRequest Model**
- `fromUser`: User ref
- `toUser`: User ref
- `skillOffered`: Skill ref
- `skillWanted`: Skill ref
- `status`: Enum (pending, accepted, rejected, completed)
- `chatId`: Chat ref (optional)

**4. Chat Model**
- `participants`: Array (User refs)
- `messages`: Array
    - `sender`: User ref
    - `text`: String
    - `timestamp`: Date
- `systemMessage`: Boolean (for trade completion notifications)

**5. Review Model**
- `reviewer`: User ref
- `reviewedUser`: User ref
- `rating`: Number (1â€“5 stars)
- `feedback`: String
- `tradeId`: TradeRequest ref
- `createdAt`: Date

---

### ðŸ“Œ Controllers

* **AuthController**
    * `registerUser`: Register a new account
    * `loginUser`: Authenticate user & return token
    * `getUserProfile`: Fetch current user data
    * `updateUserProfile`: Update bio/skills/image
* **SkillController**
    * `createSkill`: Post a new skill offering
    * `getSkillsByCategory`: Filter skills for discovery
    * `getSkillDetails`: View specific skill + owner info
* **TradeController**
    * `sendTradeRequest`: Initiate a swap
    * `respondTradeRequest`: Accept or reject incoming requests
    * `markTradeComplete`: Finalize the exchange
    * `rateUserAfterTrade`: Trigger review flow
* **ChatController**
    * `createChat`: Initialize a room after trade acceptance
    * `sendMessage`: Post a new message
    * `getUserChats`: List all active conversations
    * `getChatMessages`: Fetch message history
* **ReviewController**
    * `addReview`: Post feedback for a user
    * `getReviewsForUser`: Fetch all reviews for a profile

---

### ðŸ“Œ Routes

* `/api/auth` â†’ register, login, profile
* `/api/skills` â†’ create, list-by-category, details
* `/api/trades` â†’ send-request, respond, complete
* `/api/chats` â†’ create-chat, send-message, list-chats
* `/api/reviews` â†’ add-review, get-reviews

---

### ðŸ“Œ Middleware

* **Auth Middleware**: Verify JWT and attach `req.user`.
* **Error Handler**: Centralized middleware for catching and formatting errors.
* **Validation**: Validate request bodies (Joi or Express-validator) for email/required fields.
* **Upload Middleware**: Multer + Cloudinary storage for profile and skill images.

---

### ðŸ“Œ Utils

* `generateToken.js`: JWT sign and cookie configuration.
* `cloudinary.js`: Cloudinary SDK config for image uploads/deletions.
* `emailValidator.js`: Regex or library helper for email formats.
* `paginate.js`: Reusable helper for paginating skill lists.
* `socket.js`: Socket.IO initialization for real-time messaging.

---

### ðŸ—ï¸ Flow Recap

1.  **Auth**: User registers with profile details and skill interests.
2.  **Skill Listing**: User browses available skills by category.
3.  **Skill Detail**: User views specific skill, including owner info and past reviews.
4.  **Trade Request**: User A sends a request to User B.
5.  **Chat**: Once accepted, a chat room opens (WhatsApp-style).
6.  **Trade Complete**: Users signal completion via a system prompt.
7.  **Review**: Users leave ratings/feedback, which updates the public profile.









import { useQuery } from "@tanstack/react-query";
import { baseURL } from "../constants/baseUrl";
import SvgSpinner from "../components/SvgSpinner"; // adjust import if needed

function SkillsList({ feedType }) {
  const endpoint = `${baseURL}/api/skills?category=${feedType}`;

  const {
    data: skills,
    isLoading,
    isError,
    error,
  } = useQuery({
    queryKey: ["skills", feedType], // cache per category
    queryFn: async () => {
      const res = await fetch(endpoint, {
        method: "GET",
        credentials: "include",
      });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || data.message || "Failed to fetch skills");
      }
      return data;
    },
    staleTime: 5 * 60 * 1000, // cache for 5 minutes
  });

  if (isLoading) {
    return (
      <div style={{ display: "flex", justifyContent: "center", padding: "2rem", marginTop: "5rem" }}>
        <SvgSpinner size={36} color="#00d17e" stroke={4} />
      </div>
    );
  }

  if (isError) {
    return <p style={{ color: "red", textAlign: "center" }}>{error.message}</p>;
  }

  if (!skills || skills.length === 0) {
    return <p style={{ textAlign: "center", marginTop: "5rem" }}>No skills found in {feedType}</p>;
  }

  return (
    <div className="skills-grid">
      {skills.map((skill) => (
        <div key={skill._id} className="skill-card">
          <img
            src={skill.owner?.profileImg || "/images/placeholder.png"}
            alt="profile"
            className="profile-img"
          />
          <h3>{skill.owner?.name || "Unknown User"}</h3>
          <p className="address">{skill.owner?.address || "No address provided"}</p>
          <p><strong>Offering:</strong> {skill.skillOffered}</p>
          <p><strong>Looking for:</strong> {skill.skillWanted}</p>
        </div>
      ))}
    </div>
  );
}

export default SkillsList;



import { useMutation, useQueryClient } from "@tanstack/react-query";
import toast from "react-hot-toast";

function SkillDetail() {
  const { id } = useParams();
  const queryClient = useQueryClient();

  // âœ… Get logged-in user from cache
  const authUser = queryClient.getQueryData(["authUser"]);
  const [selectedSkill, setSelectedSkill] = React.useState("");

  // âœ… Fetch skill details
  const { data: skill, isLoading, isError, error } = useQuery({
    queryKey: ["skill", id],
    queryFn: async () => {
      const res = await fetch(`${baseURL}/api/skills/${id}`, {
        method: "GET",
        credentials: "include",
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || data.message || "Failed to fetch skill");
      return data;
    },
  });

  // âœ… Mutation for sending trade request
  const { mutate: sendTrade, isPending: tradePending } = useMutation({
    mutationFn: async ({ toUser, skillOffered, skillWanted }) => {
      const res = await fetch(`${baseURL}/api/trades/send-request`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ toUser, skillOffered, skillWanted }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || data.message || "Failed to send trade request");
      return data;
    },
    onSuccess: () => toast.success("Trade request sent successfully!"),
    onError: (err) => toast.error(err.message),
  });

  if (isLoading) return <SvgSpinner size={36} stroke={4} />;
  if (isError) return <p style={{ color: "red" }}>{error.message}</p>;
  if (!skill) return <p>Skill not found</p>;

  return (
    <div className="profile-page">
      {/* ... existing profile content ... */}

      {/* Trade Action Box */}
      <div className="sidebar-card action-card">
        <h3 className="card-title">Interested in Trade?</h3>
        <p className="card-subtitle">Choose one of your skills to offer:</p>

        {/* Dropdown of my skills */}
        <select
          value={selectedSkill}
          onChange={(e) => setSelectedSkill(e.target.value)}
          className="skill-dropdown"
        >
          <option value="">-- Select a skill --</option>
          {authUser?.skillsOffered?.map((s) => (
            <option key={s._id} value={s._id}>
              {s.title}
            </option>
          ))}
        </select>

        <button
          className="request-trade-btn"
          disabled={!selectedSkill || tradePending || authUser?._id === skill.owner?._id}
          onClick={() =>
            sendTrade({
              toUser: skill.owner?._id,   // skill owner
              skillOffered: selectedSkill, // chosen from dropdown
              skillWanted: skill._id,      // the skill being viewed
            })
          }
        >
          {tradePending ? "Sending..." : "Request Trade"}
        </button>
      </div>
    </div>
  );
}



import React from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { baseURL } from "../constants/baseUrl";
import SvgSpinner from "../utils/svgSpinner";
import { defaultImg } from "../constants/defaultImg";
import { MdChatBubble } from "react-icons/md";
import "../css/tradeDashboard.css";

function TradeDashboard() {
  const queryClient = useQueryClient();
  const authUser = queryClient.getQueryData(["authUser"]);

  // âœ… Fetch incoming trades
  const { data: incoming, isLoading: loadingIncoming } = useQuery({
    queryKey: ["incomingTrades"],
    queryFn: async () => {
      const res = await fetch(`${baseURL}/api/trades/incoming`, {
        method: "GET",
        credentials: "include",
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || data.message || "Failed to fetch incoming trades");
      return data;
    },
  });

  // âœ… Fetch approved trades
  const { data: approved, isLoading: loadingApproved } = useQuery({
    queryKey: ["approvedTrades"],
    queryFn: async () => {
      const res = await fetch(`${baseURL}/api/trades/my-trades`, {
        method: "GET",
        credentials: "include",
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || data.message || "Failed to fetch approved trades");
      return data;
    },
  });

  // âœ… Mutation for responding to trade requests
  const { mutate: respondTrade } = useMutation({
    mutationFn: async ({ id, status }) => {
      const res = await fetch(`${baseURL}/api/trades/respond/${id}`, {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || data.message || "Failed to respond to trade");
      return data;
    },
    onSuccess: () => {
      // âœ… Refresh both queries after response
      queryClient.invalidateQueries(["incomingTrades"]);
      queryClient.invalidateQueries(["approvedTrades"]);
    },
  });

  if (loadingIncoming || loadingApproved) {
    return (
      <div style={{ display: "flex", justifyContent: "center", marginTop: "5rem" }}>
        <SvgSpinner size={36} stroke={4} />
      </div>
    );
  }

  return (
    <div className="tradeDashboard-page">
      <div className="tradeDashboard-wrapper">
        {/* Page Header */}
        <div className="tradeDashboard-header">
          <h1 className="page-title">Trade Requests and Matches</h1>
          <p className="page-subtitle">Manage your incoming barter proposals and active skill exchanges.</p>
        </div>

        <div className="tradeDashboard-content">
          {/* LEFT COLUMN: RECEIVED REQUESTS */}
          <div className="tradeRequest-wrapper">
            <div className="section-header-flex">
              <h2 className="column-title">RECEIVED REQUESTS</h2>
              <span className="count-badge">{incoming?.length || 0} NEW</span>
            </div>

            <div className="trade-list">
              {incoming?.length > 0 ? (
                incoming.map((trade) => (
                  <div key={trade._id} className="tradeRequest-card">
                    <div className="card-header">
                      <img
                        src={trade.fromUser?.profileImg || defaultImg}
                        alt="profile"
                        className="user-avatar"
                      />
                      <div className="user-meta">
                        <p className="user-name">{trade.fromUser?.name}</p>
                        <p className="trade-subject">Offers {trade.skillOffered?.title}</p>
                      </div>
                    </div>

                    <div className="card-body">
                      <p className="request-message">
                        "I'd love to trade my {trade.skillOffered?.title} for your {trade.skillWanted?.title}. Let me know if you're interested!"
                      </p>
                    </div>

                    <div className="card-actions">
                      <button
                        className="accept-btn"
                        onClick={() => respondTrade({ id: trade._id, status: "accepted" })}
                      >
                        Accept
                      </button>
                      <button
                        className="reject-btn"
                        onClick={() => respondTrade({ id: trade._id, status: "rejected" })}
                      >
                        Reject
                      </button>
                    </div>
                  </div>
                ))
              ) : (
                <p className="empty-state">No requests received yet.</p>
              )}
            </div>
          </div>

          {/* RIGHT COLUMN: ACCEPTED TRADERS */}
          <div className="tradeAccepted-wrapper">
            <h2 className="column-title">ACCEPTED TRADERS</h2>

            <div className="trade-list">
              {[...(approved?.approvedReceived || []), ...(approved?.approvedSent || [])].length > 0 ? (
                [...(approved?.approvedReceived || []), ...(approved?.approvedSent || [])].map((trade) => {
                  const otherUser = trade.fromUser?._id === authUser?._id ? trade.toUser : trade.fromUser;
                  return (
                    <div key={trade._id} className="tradeAccepted-card">
                      <div className="card-content-flex">
                        <img
                          src={otherUser?.profileImg || defaultImg}
                          alt="profile"
                          className="small-avatar"
                        />
                        <div className="user-meta">
                          <p className="user-name">{otherUser?.name}</p>
                          <p className="trade-status">
                            Trading {trade.skillOffered?.title} for {trade.skillWanted?.title}
                          </p>
                        </div>
                        <